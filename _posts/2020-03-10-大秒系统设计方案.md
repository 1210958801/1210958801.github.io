---
layout: post
title: 大秒系统设计方案
tags: [秒杀] 
description: 如何设计能抗住50000QPS的秒杀系统
---
# 大秒系统设计

> 文档基本介绍

主要用来记录秒杀系统设计过程的文档

> 设计规范

##### 业务场景链条:发布商品->商品展示->商品详情倒计时->开始抢购->下订单->订单展示
##### 名词描述:前端(Mini Program)
逻辑描述->
1. 确认秒杀商品->
    1. 通过后台添加商品,前端商品展示的时候统一接收到的数据结构为[obj]
    2. 其中obj部分中会有单独的一个字段标识该商品是否为秒杀商品。
    3. 并且如果是秒杀商品的话会直接将商品的详细信息以及对应的【开始时间】返回到这个数组对象中。
2. 动静分离->
    1. 如若该字段为字符串:"[待填写销售方式]",那么需要将列表页面秒杀商品详情的数据(商品基本信息和商品的开始结束时间)带到商品详情页(页面静态化)
    2. 秒杀商品详情页面为可以下拉(移动端)刷新(其实是假的下拉,只不过前端重新渲染一遍数据,给用户制造其实已经更新的假象)
    3. 抢购按钮为disabled
3. 开始抢购->
    1. 触发条件:当倒计时为00的时候,前端的抢购按钮为enabled用户点击完之后立即变为disabled并且保持5s
    2. 下单URL:为避免懂技术的人抓包对下单URL提前访问,所以我们设计为具体url为：URL后缀md5加密一组随机串然后请求。
    3. 下订单的时候需要预留另外一个页面，那就是商品已完的页面，因为后端这里会对请求数量和库存进行把控，as:100的库存,第101个请求直接会不接受。抛弃，没有接受到响应的时候就要显示无库存的页面。

##### 名词描述:后端(Java)
##### 限流、削峰、异步处理、内存缓存
1. 秒杀url的设计:
    1. 使用Nginx,提高并发能力。
    1. 会先让前端按照规范请求一个接口获取到随机的url。
    2. 然后带着这个url请求，接过来的时候会做解密，继而找到真正实现秒杀的接口，每一个用户请求的url都不一样
2. 接口限流设计:
    1. 同一个用户xx秒内重复请求直接拒绝
    2. 两图盛千里,令牌桶实现限流
    ![](https://tva1.sinaimg.cn/large/006tNbRwly1gag1t6brgej30ns0bqjtc.jpg)
    ![](https://tva1.sinaimg.cn/large/006tNbRwly1gag1tgm7grj30hs0b8wi9.jpg)
2. 缓存以及异步下单的设计以及用途:
    1. 单机redis升级为集群redis,采用哨兵模式,可以提高redis的性能和可用性。
    2. 用redis存放每件商品的库存,请求进来的时候要用redis预减库存,之后将用户信息以及商品信息通过mq异步转发给orderServices处理订单业务。
    3. 当redis预减库存完毕，给予无库存的响应。
3. 秒杀数据库的设计:
    1. 秒杀服务单独部署，并且单独数据库，与其他99%的业务做到物理隔离。
    2. 精简SQL的利用,as:update goods set stock =stock-1 where goos_id ={#goods_id} and version = #{version} and sock>0;
4. 服务降级
    1. 如果发生了宕机,或者服务不可用,给用户一个良好的返回状态。
5. 其他部分
    1. 将每一个商品都放到ES中,提高模糊、列表响应的速度。

##### 图例
![](https://tva1.sinaimg.cn/large/006tNbRwly1gag384xemtj31d80u0gr6.jpg)
